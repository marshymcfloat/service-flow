name: CI

on:
  push:
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: serviceflow
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d serviceflow"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/serviceflow?schema=public
      DIRECT_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/serviceflow?schema=public
      NEXTAUTH_SECRET: test-nextauth-secret
      NEXTAUTH_URL: http://127.0.0.1:3000
      NEXT_PUBLIC_APP_URL: http://127.0.0.1:3000
      CRON_USER: admin
      CRON_PASSWORD: test-cron-password
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Apply migrations
        run: npx prisma migrate deploy

      - name: Lint
        run: npm run lint -- --max-warnings=0

      - name: Typecheck
        run: npm run typecheck

      - name: Unit and integration tests with coverage
        run: npm run test:ci

      - name: Production build
        run: npm run build

  e2e_smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: quality
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: serviceflow
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d serviceflow"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/serviceflow?schema=public
      DIRECT_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/serviceflow?schema=public
      NEXTAUTH_SECRET: test-nextauth-secret
      NEXTAUTH_URL: http://127.0.0.1:3100
      NEXT_PUBLIC_APP_URL: http://127.0.0.1:3100
      CRON_USER: admin
      CRON_PASSWORD: test-cron-password
      RUN_DB_E2E: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Apply migrations
        run: npx prisma migrate deploy

      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium

      - name: Platform route-protection E2E (core)
        run: npm run test:e2e:core

      - name: Check DB health for booking smoke (required)
        run: |
          node -e "const { Client } = require('pg'); const client = new Client({ connectionString: process.env.DATABASE_URL, connectionTimeoutMillis: 3000 }); client.connect().then(() => client.end()).catch((error) => { console.error('DB health check failed:', error.message); process.exit(1); });"

      - name: Booking smoke E2E (db)
        run: npm run test:e2e:db
